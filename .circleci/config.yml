version: 2
jobs:
  build:
    docker:
      - image: cimg/openjdk:18.0.2-node

    environment:
      # Configure the JVM and Gradle to avoid OOM errors
      _JAVA_OPTIONS: "-Xmx3g"
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"
    steps:
      - checkout
      - run: java --version
      - run:
          name: Build the GraalVM Compiler and embed it into the JDK (JDK8 with JVMCI enabled)
          command: |
            echo ">>>> Using JDK8_JVMCI_HOME as JAVA_HOME (${JAVA_HOME})"
            ./build/x86_64/linux_macos/lib/buildGraalCompiler.sh ${BASEDIR} ${MX} ${BUILD_ARTIFACTS_DIR}
          timeout: 10m
          no_output_timeout: 7m
          
      - run:
          name: Install dependencies
          command: ./gradlew clean build -Dquarkus.package.type=native -Dquarkus.native.container-build=true

      - persist_to_workspace:
          root: .
          paths:
            - build

      - store_artifacts:
          path: build/libs

workflows:
  version: 2
  workflow:
    jobs:
      - build